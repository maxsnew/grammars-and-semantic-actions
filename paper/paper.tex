\documentclass[acmsmall,anonymous,review,screen]{acmart}
\usepackage{mathpartir}
\usepackage{tikz-cd}
\usepackage{enumitem}
\usepackage{wrapfig}
\usepackage{fancyvrb}

\newcommand{\cat}[1]{\mathbf{#1}}
\newcommand{\Set}{\cat{Set}}
\newcommand{\lto}{\multimap}

%% Rights management information.  This information is sent to you
%% when you complete the rights form.  These commands have SAMPLE
%% values in them; it is your responsibility as an author to replace
%% the commands and values with those provided to you when you
%% complete the rights form.
\setcopyright{acmcopyright}
\copyrightyear{2018}
\acmYear{2018}
\acmDOI{XXXXXXX.XXXXXXX}

%% These commands are for a PROCEEDINGS abstract or paper.
\acmConference[Woodstock '18]{Woodstock '18: ACM Symposium on Neural
  Gaze Detection}{June 03--05, 2018}{Woodstock, NY}
\acmBooktitle{Woodstock '18: ACM Symposium on Neural Gaze Detection,
  June 03--05, 2018, Woodstock, NY}
\acmPrice{15.00}
\acmISBN{978-1-4503-XXXX-X/18/06}


\begin{document}
\title{Formal Grammars as Types in Non-commutative Bunched Type Theory}
\author{Steven Schaefer}
\affiliation{
  \department{Electrical Engineering and Computer Science}
  \institution{University of Michigan}
  \country{USA}
}
\email{stschaef@umich.edu}

% TODO: add Pedro's info


\author{Max S. New}
\affiliation{
  \department{Electrical Engineering and Computer Science}
  \institution{University of Michigan}
  \country{USA}
}
\email{maxsnew@umich.edu}

\author{Pedro H. Azevedo de Amorim}
\affiliation{
  \department{Department of Computer Science}
  \institution{University of Oxford}
  \country{UK}
}
\email{pedro.azevedo.de.amorim@cs.ox.ac.uk}

\begin{abstract}
  We propose the category of functions from strings to sets as a
  universal syntax-independent model of formal grammars, generalizing
  the set of strings model of formal language theory to account for
  ambiguity. The morphisms of this category give a notion of parse
  transformer, and isomorphism corresponds to \emph{strong
  equivalence} of grammars. We observe that the standard algebraic
  constructions of regular expressions and their extension to
  mu-regular expressions correspond to universal constructions in this
  category, which we axiomatize as a structure we call a 2-Kleene
  Algebra.

  
\end{abstract}

\section{A Syntax-Independent Notion of Syntax}

The theory of formal languages and parsing is one of the oldest and
most thoroughly developed areas of theoretical computer science. A
prominent topic in the 1950s and 60s led to a series of remarkable
developments: Chomsky's hierarchy of grammar formalisms, practical
algorithms for parsing of regular and context-free grammars and
variants, as well as implementations of practical tools for the
generation of efficient parsers.

A central notion is that of a \emph{formal language} $L$ over an
alphabet $\Sigma$ as simply a \emph{subset} of the set of strings $L
\subseteq \Sigma^*$. This definition is especially useful as it gives
a semantics to formal grammars that is completely independent of any
particular syntactic grammar formalism: any new notion of grammar can
be given a semantics in this common framework and it provides a
precise mathematical speicification for implementing a
\emph{recognizer} of a language and comparing the power of different
formalisms by demonstrating what languages can be formalized within
it. This also allows for completely \emph{language theoretic}
formulations of language classes: e.g., the regular \emph{languages}
can be characterized as those that have finitely many derivatives
\cite{brzozowski-or-myhill-nerode-idk}. This notion is remarkable
because it makes no reference to any specific syntactic formalism for
defining languages such as regular expressions or finite automata.

Formal language theory alone is not sufficient as a specification of a
parser: a language $L \subseteq \Sigma^*$ is equivalently defined as
its indicator function $\chi_L : \Sigma^* \to \Prop$ mapping each
string $w$ to the proposition that it is in the language $w \in
L$. This can then serve as the specification for a language
\emph{recognizer}: a program $r$ of type $\Sigma^* \to \Bool$ such
that $r(w) = \texttt{true}$ if and only if $\chi_L(w)$, but
recognition is insufficient for most tasks for which the theory of
parsing was developed: the production of \emph{semantic} structures
from synactic descriptions in linguistics, compilation or
deserialization. The output of a parser is not just a boolean but a
\emph{parse tree}\footnote{such parse trees are usually not
materialized in memory, as the construction of the parse tree is fused
with application of semantic actions, which can be seen as a kind of
fold over the generated tree.}.

Due to this limitation, parsers are typically specified not by a
formal language, but by some \emph{formal grammar}, which specifies
not just \emph{which} strings are in the language but specifies what
are the \emph{parse trees} for the string. However unlike formal
language theory, there is no common universal notion of what
constitutes a formal grammar, but rather many syntactic systems such
as Chomskyan(?)  grammars, Thue systems, Montague grammars, etc which
are all syntactic presentations of the same underlying idea of an
abstract specification for parsing. The most common of these is the
Chomsky hierarchy of \emph{generative} grammars which specify parse
trees using \emph{derivations} of the string from a set of rewrite
rules, the parse tree encoding which rules were used.

Our first contribution is conceptual: we propose a simple,
syntax-independent definition of \emph{formal grammar}:
\begin{definition}
  A \emph{formal grammar} over an alphabet $\Sigma$ is a function
  $\Sigma^* \to \Set$.
\end{definition}
We say that a grammar $G$ associates to every string $w$ the set $Gw$
of \emph{parses} of that string. While we will work informally in this
paper, the collection $\Set$ can be formalized in many different
logical foundations: as a universe in type theory, a proper class in
set theory, etc. We argue that this is already a common intuition
latent in much prior work on grammars, especially when comparing
different formalisms for equivalence such as \cite{??}. This notion is
also completely natural in the context of constructive type theories
such as Agda which until recently did not include a universe of
propositions, and so for example in Elliott (\cite{??}) a formal
language was defined as a function to the universe $\Type$ with little
comment.

Every formal grammar $G$ induces a formal language, which can be seen
most easily by using the characteristic function formulation: we can
``squash'' any set into the proposition that it is inhabited, so
$\chi_G(w) = ||G(w)||$ which defines a subset $L_G = \{ w \in
\Sigma^*| G(w) \mathrm{inhabited}\}$.

Formal languages naturally arrange themselves into a partial order by
using the subset inclusion as the ordering. Formal grammars naturally
arrange themselves into a \emph{category} where a morphism $\alpha : G
\to H$ is given by a \emph{family} of functions
\[ \alpha^w : Gw \to Hw \]
for every string $w \in \Sigma^*$. The intuition is that a morphism of
grammars is a \emph{translation of parses}: a $G$-parse of $w$ gets
transformed to an $H$-parse of $w$. This then induces a notion of
\emph{isomorphism} of grammars: two grammars are equivalent if there
is a bijective translation of parses, precisely capturing the notion
of a \emph{strong equivalence} of grammars.

This category-theoretic framework can be further used to describe and
compare different notions of formal grammar. We can define a
\emph{notion of grammar} to be a category (or perhaps just groupoid)
paired with a functor into $\Set^{\Sigma^*}$. This naturally forms a
2-category the slice 2-category over $\Set^{\Sigma^*}$ and equivalence
in this 2-category defines a sensible notion of \emph{strong
equivalence of grammar formalisms} (TODO: check details).

The category of grammars is quite rich in structure, which can be most
easily observed from the fact that it is equivalently defined as the
category of functors $\Set^{\Sigma^*}$ where $\Sigma^*$ is here viewed
as a discrete category, that is, the objects are strings and only
morphisms are identity morphisms. Such functor categories, often
called presheaf categories, are incredibly rich in structure, which we
will exploit in section \ref{blah} to succinctly define the semantics
of regular and context-free grammars.

\section{Kleene Category}

Kleene algebras are an important tool in the theory of regular
languages. More broadly, they serve as a theoretical substrate to
studying various kinds of formal languages. Formally, they are a tuple
$(A, +, \cdot, (-)^*, 1, 0)$, where $A$ is a set, $+$ and $\cdot$
are binary operations over $A$, $(-)^*$ is a function over $A$, and
$1$ and $0$ are constants. These structures satisfy the axoims depicted
in Figure~\ref{fig:axioms}.

\begin{figure}
  \begin{align*}
    x + (y + z) &= (x + y) + z & x + y &= y + x\\
    x + 0 &= x & x + x &= x\\
    x(yz) &= (xy)z & x1 &= 1x = x\\
    x(y + z) &= xy + xz & (x + y)z &= xz + yz\\
    x0 &= 0x = x & & \\
    1 + aa^* &\leq a^* & 1 + a^*a &\leq a^*\\
     b + ax \leq x &\implies a^*b \leq x &  b + xa \leq x &\implies ba^* \leq x
  \end{align*}
  \label{fig:axioms}
  \caption{Kleene algebra axioms}
\end{figure}

The addition operation can be used to define the partial order
structure $a \leq b$ if $a + b = b$. In the theory of formal languages
this order structure can be used to model language containment. In this
section, we want to categorify the concept of Kleene algebra and
build on top of it in order to define an abstract theory of parsing.
We start by defining \emph{Kleene categories}.

\begin{definition}
  A Kleene category is a distributive monoidal category $\cat{K}$
  such that for every objects $A$ and $B$, the endofunctors $F_{A, B}
  = B + A \otimes X$ and $G_{A, B} = B + X \otimes A$ have initial
  algebras (denoted $\mu X.\, F_{A, B}(X)$) such that $B \otimes (\mu
  X.\, F_{A, 1}) \cong \mu X.\, F_{A, B}(X)$ and the analogue isomorphism
  for $G_{A,B}$ also holds.
\end{definition}

As a sanity check, note that Kleene algebras are indeed examples of
Kleene categories.

\begin{example}
  Every Kleene algebra, seen a posetal category, is a Kleene category.
\end{example}

An unexpected example comes from the theory of substructural logics.

\begin{example}
  The opposite category of every Kleene category is a model of a variant of
  conjunctive ordered logic, where the Kleene star plays the role of the ``of
  course'' modality from substructural logics.
\end{example}

This proposed definition is sensible. After all, the proposed axioms
are a direct translation of the Kleene algebra axioms to a categorical
setting. Its most convoluted aspect is the axiomatization of the Kleene
star as a family os initial algebras satisfying certain
isomorphisms. If the Kleene category $\cat{K}$ has more structure,
then these isomorphisms hold ``for free''.

\begin{theorem}
  \label{th:kleeneclosed}
  Let $\cat{K}$ be a Kleene category such that it is also monoidal
  closed.  Then, the initial algebras isomorphisms hold automatically.
\end{theorem}
\begin{proof}
  We prove this by the unicity (up-to isomorphism) of initial
  algebras. Let $[hd, tl]: 1 + (\mu X.\, F_{A, 1}(X)) \otimes A \to
  (\mu X.\, F_{A, 1}(X))$ be the initial algebra structure of $(\mu
  X.\, F_{A, 1}(X))$ and consider the map $[hd, tl] : B + B \otimes
  (\mu X.\, F_{A, 1}(X)) \otimes A \to B\otimes (\mu X.\, F_{A,
    1}(X))$.

  Now, let $[f,g] : B + A \otimes Y \to Y$ be an $F_{A,B}$-algebra and
  we want to show that there is a unique algebra morphism $h : B
  \otimes \mu X.\, F_{A,1} \to Y$. We can show existence and uniqueness
  by showing that the diagram on the left commute if, and only if,
  the diagram on the right commutes:

  This equivalence follows by using the adjunction structure given
  by the monoidal closed structure of $\cat{K}$. A completely analogous
  argument for $G_{A,B}$ also holds.
\end{proof}

This result feels similar in spirit to the definition of action
algebras, which are algebras where the product also has adjoint
operations which results in the Kleene star being more easily
axiomatized \cite{kozen1994}. We are now ready to prove that our
concept of formal grammars fit nicely within our categorical
framework. We start by presenting a well-known construction
from presheaf categories.

\begin{definition}
  Let $\cat{C}$ be a locally small monoidal category and $F$, $G$ be
  two functors $\cat{C} \to \Set$. Their Day convolution tensor
  product is defined as the following coend formula:
  \[
  (F \otimes_{Day} G)(x) = \int^{(y,z) \in \cat{C}\times\cat{C}}\cat{C}(y\otimes z, x) \times F(y) \times G(z) 
  \]
  Dually, its internal hom is given by the following end formula:
  \[
  (F \lto_{Day} G)(x) = \int_{y} \Set(F(y), G(x \otimes y))
  \]
\end{definition}

\begin{lemma}[\cite{day1970}]
  Under the assumptions above, the presheaf category $\Set^{\cat{C}}$ is
  monoidal closed.
\end{lemma}

%% \begin{theorem}
%%   Let $\cat{K}$ be a Kleene category and $A$ a discrete category.
%%   The functor category $[A, \cat{K}]$.
%%   (HOW GENERAL SHOULD THIS THEOREM BE? BY ASSUMING ENOUGH STRUCTURE,
%%   E.G. K = Set, THIS THEOREM BECOMES SIMPLE TO PROVE)
%% \end{theorem}
\begin{theorem}
  If $\cat{C}$ is a locally small monoidal category, then
  $\Set^{\cat{C}}$ is a Kleene category.
\end{theorem}
\begin{proof}

  By the lemma above, $\Set^{\cat{C}}$ is monoidal closed, and since it
  is a presheaf category, it has coproducts, and since the tensor
  is a left adjoint, it preserves colimits and, therefore, it is
  a distributive category.

  As for the Kleene star, since presheaf categories admit small colimits,
  the initial algebra of the functors $F_{A,B}$ and $G_{A,B}$ can be
  defined as the filtered colimit of the diagrams:

  From Theorem~\ref{th:kleeneclosed} it follows that these initial
  algebras satisfy the required isomorphisms and this concludes the
  proof.
\end{proof}

\begin{corollary}
  For every alphabet $\Sigma$, the presheaf category $\Set^{\cat{\Sigma^*}}$
  is a Kleene category.
\end{corollary}
\begin{proof}
  Note that string concatenation and the empty string make the
  discrete category $\Sigma^*$ a strict monoidal category.
\end{proof}

\section{Related work}

\paragraph{Kleene Algebra}

Since the early works in the theory of formal languages, Kleene
algebras have played an important role in its development. They
generalize the operations known from regular languages by introducing
operations generalizing language composition, language union and the
Kleene star.  More generally, they are defined as inequational theory
where the inequality is meant to capture language containment. This
theory is extremely successful, having found applications in algebraic
path problems, theory of programming languages, compiler optimizations
and more.

A frequently fruitful research direction is exploring varying
extensions of Kleene algebras, Kleene algebra with tests (KAT) being
one of the most notable ones. Our approach is radically different from
most extensions, which usually aim at modifying or adding new
operations to Kleene algebras, but still keeping it as an inequational
theory. By adopting a category-theoretic treatment and allowing the
``order structure'' to encode more information than merely
inequalities, we were able to extend Kleene algebra to reason about
parsing as well.

\section{Future work}

\subsection{Beyond Strings}

While parsing typically refers to the production of semantic objects
from their description as strings, many tasks in programming can be
viewed as parsing of more structured objects such as trees, trees with
binding structure or graphs. Fundamental to programming language
implementation is \emph{type checking}, analogous to language
recognition, or more generally \emph{typed elaboration}, analogous to
parsing, which produces a semantic object in addition to performing
some analysis.



\end{document}
